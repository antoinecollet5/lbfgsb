name: CI

on:
  push:
    # on every branch
    branches:
      - '*'

env:
  PIP_CACHE_DIR: ${{ github.workspace }}/.cache/pip
  QT_DEBUG_PLUGINS: 1
  QT_QPA_PLATFORM: offscreen

jobs:
  static_analysis:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13

      - name: Install dependencies with uv
        run: |
          pip install uv
          uv venv
          uv pip install -e ".[all]"

      - name: Run pre-commit hooks
        run: |
          uv run pre-commit run --all-files  # Run pre-commit inside the uv virtual environment

        continue-on-error: false

      - name: Upload pre-commit report
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: pre-commit-report
          path: pre-commit-report

  tests-legacy:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ["3.7"]

    env:
      NUMBA_DISABLE_JIT: 1

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install deps (pip)
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -U pip setuptools wheel
          pip install -e .[all]

      - name: Run tests
        run: |
          source .venv/bin/activate
          pytest --cov=lbfgsb --cov-config=.coveragerc --cov-report=

      - name: Rename coverage file
        run: |
          mv .coverage .coverage.${{ matrix.python-version }}

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: .coverage.${{ matrix.python-version }}
          if-no-files-found: error

  tests:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]

    env:
      NUMBA_DISABLE_JIT: 1

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv + deps
        run: |
          pip install uv
          uv venv
          uv pip install -e .[all]

      - name: Run tests with coverage
        run: |
          uv run pytest \
            --cov=lbfgsb \
            --cov-config=.coveragerc \
            --cov-report=term \
            --color=yes

      - name: Collect coverage files
        if: always()
        run: |
          mkdir -p coverage-files
          cp .coverage* coverage-files/ 2>/dev/null || true

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage-files
          if-no-files-found: error


  coverage-merge:
    runs-on: ubuntu-22.04
    needs:
      - tests-legacy
      - tests

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13

      - name: Install coverage
        run: pip install coverage

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage-data

      - name: Combine coverage
        run: |
          ls -la coverage-data/**/*
          coverage combine coverage-data/**/.coverage.*
          coverage report -m
          coverage html
          coverage xml

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
